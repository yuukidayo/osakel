# お酒詳細検索機能の実装ドキュメント

## 1. 概要

お酒検索画面では、ユーザーが選択したお酒のカテゴリ（ビール、ワイン、ウイスキー、日本酒など）に応じて、適切な詳細検索項目が動的に表示される仕組みを実装しています。これにより、各お酒の特性に合わせた効率的な検索体験を提供しています。

## 2. 基本構造

### 2.1 共通フィルター項目

すべてのカテゴリで共通して表示される検索項目：
- **生産国**：日本、アメリカ、フランスなど
- **生産エリア**：北海道、東北、関東など
- **アルコール度数**：0%〜60%のレンジスライダー
- **シリーズ**：レギュラー、プレミアム、スペシャルなど
- **メーカー**：サントリー、キリン、アサヒなど
- **価格帯**：価格範囲選択

### 2.2 カテゴリ固有のフィルター項目

#### ウイスキー
- **タイプ**：シングルモルト、ブレンデッド、バーボン、ライ、ジャパニーズなど
- **原料**：モルト、グレーン、ライ麦、トウモロコシ、大麦、小麦など
- **熟成年数**：年数選択
- **ビンテージ**：製造年選択
- **オールドボトル**：オールドボトルのみ表示切り替え

#### リキュール
- **テイスト**：フルーツ系、ハーブ系、スパイス系、ナッツ系、甘口、辛口、クリーミー、酸味、ビター、チョコレート系など

#### ワイン
- **ワインタイプ**：赤、白、ロゼ、スパークリングなど
- **ぶどう品種**：カベルネ・ソーヴィニヨン、メルロー、シャルドネなど
- **ヴィンテージ**：収穫年選択

#### ビール
- **ビールタイプ**：ラガー、エール、IPA、スタウトなど
- **製法**：製法による分類

#### 日本酒
- **種類**：純米、大吟醸、吟醸、本醸造など
- **精米歩合**：何%まで米を磨いているか
- **味わい**：辛口、甘口など

## 3. 実装の詳細

### 3.1 主要クラスとその役割

- **`DrinkFilterOptions`クラス**：
  - フィルターオプションの定義と管理
  - カテゴリごとの固有フィルター項目の生成
  - UIウィジェットの構築メソッド提供

- **`FilterOption`クラス**：
  - 個別のフィルターオプション定義
  - タイプ、ラベル、UIウィジェット構築メソッドを保持

- **`FilterOptionType`enum**：
  - フィルターオプションの種類を定義
  - 例：country, region, alcohol, type, vintage, material, oldBottle など

### 3.2 カテゴリに応じた検索項目の切り替え処理の流れ

1. **カテゴリの選択**：
   - ユーザーがUI上でカテゴリを選択（ビール、ワイン、ウイスキーなど）
   - `_DrinkSearchScreenState` クラスの `_onCategorySelected` メソッドが呼び出される

2. **選択状態の更新**：
   - 選択されたカテゴリIDとカテゴリ名を状態変数に保存
   - サブカテゴリ一覧の更新

3. **詳細検索ボタンタップ**：
   - ユーザーが「詳細検索」ボタンをタップ
   - `_showFilterBottomSheet` メソッドが呼び出される

4. **フィルターオプションの取得**：
   - 現在選択されているカテゴリIDを使用
   - `DrinkFilterOptions.getOptionsForCategory` メソッドを呼び出し
   - このメソッドに以下の情報を渡す:
     - BuildContext (UIコンテキスト)
     - 選択されているカテゴリID
     - 現在のフィルター値
     - フィルター変更時のコールバック関数

5. **カテゴリに応じたフィルター項目の決定**：
   - `getOptionsForCategory` メソッド内で、カテゴリIDに応じて適切な項目を返す
   - "beer" → ビール用の項目
   - "wine" → ワイン用の項目
   - "whisky" → ウイスキー用の項目
   - "sake" → 日本酒用の項目
   - その他/すべて → 共通項目のみ

6. **フィルター項目のUI生成**：
   - 取得したフィルターオプションリストを使用してUIを構築
   - 各フィルターオプションごとに `_buildFilterOptionItem` メソッドを呼び出し
   - これにより、各項目に対応するUIウィジェットが生成される

7. **モーダルボトムシートとしての表示**：
   - 生成されたフィルター項目UIをモーダルボトムシートとして表示
   - ユーザーによるフィルター項目の選択・調整が可能に

8. **フィルター適用ボタン押下**：
   - ユーザーが「適用」ボタンをタップ
   - 選択されたフィルター条件で検索が実行される
   - 検索結果がUI上に反映される

### 3.3 コード例：カテゴリごとのフィルター項目取得

```dart
// カテゴリIDに応じたフィルターオプションを取得
static List<FilterOption> getOptionsForCategory(
  BuildContext context,
  String categoryId,
  Map<String, dynamic> filterValues,
  Function(String, dynamic) onFilterChanged
) {
  switch (categoryId) {
    case 'beer':
      return beerOptions(context, filterValues, onFilterChanged);
    case 'wine':
      return wineOptions(context, filterValues, onFilterChanged);
    case 'whisky':
      return whiskyOptions(context, filterValues, onFilterChanged);
    case 'sake':
      return sakeOptions(context, filterValues, onFilterChanged);
    default:
      // すべてのカテゴリまたは未知のカテゴリの場合は共通項目のみ
      return commonOptions(context, filterValues, onFilterChanged);
  }
}
```

## 4. 拡張と今後の展望

- **新カテゴリの追加**：
  - 新しいお酒カテゴリを追加する場合、DrinkFilterOptionsクラスに対応するメソッドを実装
  - FilterOptionTypeに必要な新しい項目タイプを追加

- **検索精度の向上**：
  - Firestore検索クエリの最適化
  - 複雑な検索条件の組み合わせ対応

- **UIの改善**：
  - フィルター項目の視覚的な分類や整理
  - ユーザー使用パターンに基づく項目の並べ替え

## 5. 技術的注意点

- フィルター項目の追加・変更時には、対応するFirestore検索クエリも更新が必要
- ウィジェットビルダーメソッドは再利用可能な設計になっているため、似たUIが必要な項目では共通メソッドを活用できる
- パフォーマンス向上のため、フィルターUIは必要に応じて遅延ロードも検討可能
